<!DOCTYPE html>
<html lang="ch">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>上传视频</title>
  <link rel="stylesheet" href="./font class/iconfont.css">
  <link rel="stylesheet" href="https://neveragain.allstatics.com/2019/assets/style/bootstrap-wondershare.min.css">
  <style>
    * {
      user-select: none;
    }

    ul,
    li {
      padding: 0;
      margin: 0;
    }

    li {
      list-style: none;
    }

    .header {
      width: 100%;
      padding-right: 20px;
      height: 50px;
      line-height: 50px;
      font-size: 16px;
      border-bottom: 1px solid rgb(202, 201, 201);
      text-indent: 20px;
    }

    .header button {
      width: 70px;
      height: 30px;
      line-height: 30px;
      border: none;
      border-radius: 15px;
      color: #fff;
      cursor: pointer;
      outline: none;
      margin: 10px 8px;
    }

    .main-wrapper {
      width: 100%;

    }

    .main-wrapper .left {
      width: 15%;
      height: 646px;
      padding: 15px;
      box-sizing: border-box;
      float: left;
      border-right: 1px solid rgb(202, 201, 201);
    }

    .main-wrapper .left .top {
      width: 100%;
      color: rgb(124, 124, 124);
    }

    .main-wrapper .left .top .title {
      height: 40px;
      line-height: 40px;
      font-size: 14px;

    }

    .main-wrapper .left .top button {
      width: 120px;
      height: 30px;
      border: none;
      border-radius: 20px;
      background-color: rgb(238, 122, 55);
      color: #fff;
      cursor: pointer;
      outline: none;
      margin: 15px 20px;
    }

    #dataList {
      height: 400px;
      position: relative;
    }

    #dataList .tip {
      position: absolute;
      line-height: 30px;
      width: 91%;
      top: 40%;
      left: 20px;
      text-align: center;
      color: rgb(124, 124, 124);
    }

    .main-wrapper .right {
      width: 85%;
      height: 646px;
      float: left;
      overflow: hidden;
    }

    .main-wrapper .right .title {
      height: 80px;
      padding-right: 20px;
      line-height: 80px;
      font-size: 20px;
      text-align: center;
      letter-spacing: 20px;
      border-bottom: 1px solid rgb(202, 201, 201);
    }

    .main-wrapper .right .content {
      width: 100%;
      height: 100%;
      background-image: linear-gradient(90deg, rgba(180, 180, 180, 0.15) 10%, rgba(0, 0, 0, 0) 10%), linear-gradient(rgba(180, 180, 180, 0.15) 10%, rgba(0, 0, 0, 0) 10%);
      background-size: 20px 20px;
      box-sizing: border-box;
      float: left;
      position: relative;
      overflow: hidden;
    }

    .main-wrapper .right #content-wrapper {
      position: absolute;
    }

    .main-wrapper .right #content-wrapper .branch {
      width: 160px;
      height: 120px;
      border-radius: 10px;
      box-shadow: 4px 4px 20px rgb(184, 184, 184);
      background-color: #fff;
      font-size: 14px;
    }

    #head-branch {
      top: 50px;
      left: 20px;
    }

    .main-wrapper .right #content-wrapper .img-wrapper {
      height: 90px;
      background-color: rgb(158, 157, 157);
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      position: relative;
    }

    .main-wrapper .right #content-wrapper .img-wrapper .head-text {
      width: 65px;
      height: 25px;
      line-height: 25px;
      background-color: rgb(240, 122, 68);
      position: absolute;
      top: 0;
      left: 0;
      color: #fff;
      text-align: center;
    }

    .main-wrapper .right #content-wrapper .img-wrapper .icon-jia {
      position: absolute;
      bottom: -10px;
      right: 10px;
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: rgb(240, 122, 68);
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
      outline: none;
    }

    .main-wrapper .right #content-wrapper .img-wrapper video {
      width: 100%;
      height: 90px;
      /* border-radius: 5px; */
    }

    .main-wrapper .right #content-wrapper p {
      height: 30px;
      line-height: 30px;
      margin: 0;
      text-indent: 10px;
    }

    #videoFile {
      margin-top: 40px;
      text-align: center;
      height: 480px;
      overflow: auto;
      display: none;
    }

    #videoFile li video {
      width: 85%;
      height: 90px;
      border-radius: 5px;
    }

    #videoFile li p {
      font-size: 14px;
    }

    .line {
      top: 50%;
      left: -80px;
      width: 88px;
      height: 1px;
      background-color: rgb(110, 110, 110);
    }

    .icon-edit {
      display: inline-block;
      position: absolute;
      bottom: -10px;
      right: -10px;
    }

    .but {
      width: 54px;
      height: 35px;
      border: 1px solid transparent;
      padding: .375rem .75rem;
      border-radius: .25rem;
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }

    .btn-cancel {
      color: #fff;
      background-color: #6c757d;
      border-color: #6c757d;
    }

    .btn-cancel:hover {
      color: #fff;
      background-color: #5a6268;
      border-color: #545b62;
    }

    .btn-save {
      color: #fff;
      background-color: rgb(238, 122, 55);
      border-color: rgb(238, 122, 55);
    }

    .btn-save:hover {
      color: #fff;
      background-color: rgb(247, 110, 30);
      border-color: rgba(250, 119, 44, 0.925);
    }

    .bgcolor {
      background-color: rgb(238, 122, 55);
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="row">
      <div class="col-10">互动视频上传</div>
      <div class="col-2 font-size-small">
        <button style="background-color: #fff;border:1px solid #000;color: #000;" id="publish">发布</button>
        <button style="background-color: rgb(238, 122, 55);" id="preShow">预览</button>
      </div>
    </div>
  </div>
  <div class="main-wrapper">
    <div class="left">
      <div class="top">
        <div class="title">素材库</div>
        <input type="file" id="upfile" name="upfile" style="display: none;" multiple="multiple">
        <button id="imgData"><i class="iconfont icon-shipin"></i> 添加素材</button>
      </div>
      <div id="dataList">
        <div class="tip">你还没有上传视频素材，请上传视频</div>
      </div>
      <ul id="videoFile"></ul>
    </div>
    <div class="right">
      <div class="title">时间轴</div>
      <div class="content p-5">
        <div id="content-wrapper">
          <div class="branch position-relative" id="head-branch" data-question=""
            data-answer=''>
            <div class="branch-content">
              <div class="img-wrapper">
                <video src="" alt=""></video>
                <span class="head-text">片头</span>
                <span class="icon icon-jia"><i class="iconfont icon-jia1"></i></span>
                <img src="images/editor.svg" alt="" class="img-fliud icon-edit d-none" data-toggle="modal"
                  data-target="#modal-edit">
                <img src="images/fold.svg" alt="" class="img-fluid position-absolute d-none icon-fold"
                  style="top: 56%;right: 0;transform: rotate(45deg);z-index: 99;">
                <img src="images/open.svg" alt="" class="img-fluid position-absolute d-none icon-open"
                  style="top: 56%;right: 0;transform: rotate(45deg);z-index: 99;">
              </div>
              <p class="text">拖入视频</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modal-edit">
      <div class="modal-dialog ">
        <div class="modal-content with-box-shadow p-3 bg-white text-center font-size-small"
          style="border-radius: 4px;border: 0;width: 400px;height: auto;">
          <div class="modal-body">
            <div class="py-3 border-bottom font-weight-bolder">选项分支编辑</div>
            <div class="form-group pt-3">
              <label for="question">选项问题</label>
              <input type="text" class="ml-3 border-radius pl-3 w-75" id="question" placeholder="选填">
            </div>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>选项</th>
                  <th>选项内容</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>A</td>
                  <td><input type="text" name="" id="answerA" placeholder="选填" class="pl-3"></td>
                </tr>
                <tr>
                  <td>B</td>
                  <td><input type="text" name="" id="answerB" placeholder="选填" class="pl-3"></td>
                </tr>
                <tr>
                  <td>C</td>
                  <td><input type="text" name="" id="answerC" placeholder="选填" class="pl-3"></td>
                </tr>
                <tr>
                  <td>D</td>
                  <td><input type="text" name="" id="answerD" placeholder="选填" class="pl-3"></td>
                </tr>
              </tbody>
            </table>
            <div class="font-size-tiny text-gray-7">注：选项顺序按分支顺序对应</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="but btn-cancel" data-dismiss="modal">取消</button>
            <button type="button" class="but btn-save" id="question-save">保存</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://neveragain.allstatics.com/2019/assets/vendor/wsc-vendor.js"></script>
<script src="https://neveragain.allstatics.com/2019/assets/script/wsc-override-ws.js"></script>
<script src="https://neveragain.allstatics.com/2019/assets/script/wsc-common.js"></script>
<script>$(function () { wsc.common.init() })</script>
<script>
  window.onload = function () {
    let oFile = document.getElementById('upfile');
    let oContentWrapper = document.getElementById('content-wrapper');

    //  监听当前点击的是哪个元素
    // $(document).mousedown(function (e) {
    //     console.log($(e.target));  //当前点击的元素
    // })

    $upFile = $("#upfile");
    $("#imgData").click(function () {
      $upFile.click();
      $upFile.off("change").on('change', (function () {
        // console.log(oFile.files.length);
        for (let i = 0; i < oFile.files.length; i++) {
          upFile(oFile.files[i]);
        }
      }));
    });

    //  上传视频文件到后台
    let upFile = function (file) {
      let formData = new FormData();
      formData.append("upfile", file);
      $.ajax({
        url: './updata.php',
        type: 'post',
        data: formData,
        dataType: "json",
        cache: false,
        contentType: false,
        processData: false,
        success: function (data) {
          console.log(data);
          $('#dataList').hide();
          $('#videoFile').css('display', 'block');
          addvideoList(data);
        },
        error: function (err) {
          console.log(err);
        }
      });
    };

    //  上传视频成功后加入素材库
    let addvideoList = function (video) {
      $('#videoFile').append(`<li><video src="./upload/${video.src}" draggable="true"></video>
                    <p>${video.name.split('.')[0]}</p></li>`);
    }

    // 视频拖入画布功能
    let dragVideo = function () {
      $('#videoFile').find('video').forEach(video => {
      });
    }


    // -----------------------------------------分支逻辑开始--------------------------------------------------------
    //  添加分支
    $('#content-wrapper').on('click', '.icon-jia', function (event) {
      let _this = $(this);
      let parentBranch = _this.parent().parent().parent();
      // console.log(parentBranch.siblings().not('.branch-content').find('.icon-open'))

      for (let i = 0; i < parentBranch.siblings().not('.branch-content').length; i++) {
        if (parentBranch.siblings().not('.branch-content').eq(i).find('.branch').length > 0) {
          foldBranch(parentBranch.siblings().not('.branch-content').eq(i).find('.icon-fold').eq(0))
        }
      }

      openBranch(_this.next().next().next())
      parentBranch.find('.icon-edit').eq(0).removeClass('d-none');
      parentBranch.find('.icon-fold').eq(0).removeClass('d-none');
      parentBranch.find('.icon-open').eq(0).addClass('d-none');

      //  限定最多4条分支
      if (parentBranch.children('.branch').length < 4) {
        branchLocation(parentBranch);
        exchangeBranch(parentBranch);
      }

      event.stopPropagation();
    });

    //  整理不同分支位置
    let exchangeBranch = function (parentBranch) {
      switch (parentBranch.children('.branch').length) {
        case 1: changeLocation(parentBranch.children('.branch').eq(0), "0px", '0', '50%'); break;
        case 2: changeLocation(parentBranch.children('.branch').eq(0), "80px", '-40', '90%');
          changeLocation(parentBranch.children('.branch').eq(1), "-80px", '40', '10%'); break;
        case 3: changeLocation(parentBranch.children('.branch').eq(0), "140px", '-33', '100%');
          changeLocation(parentBranch.children('.branch').eq(1), "0px", '0', '50%');
          changeLocation(parentBranch.children('.branch').eq(2), "-140px", '38', '1%');
          break;
        case 4: changeLocation(parentBranch.children('.branch').eq(0), "225px", '-50', '129%');
          changeLocation(parentBranch.children('.branch').eq(1), "74px", '-50', '87%');
          changeLocation(parentBranch.children('.branch').eq(2), "-72px", '50', '30%');
          changeLocation(parentBranch.children('.branch').eq(3), "-220px", '50', '-13%');
      }
    }
    
    //  给分支收缩绑定点击事件
    $('#content-wrapper ').on('click', '.icon-fold', function (event) {
      let _this = $(this);
      foldBranch($(_this));
      event.stopPropagation();
    })

    //  给分支展开绑定点击事件
    $('#content-wrapper').on('click', '.icon-open', function (event) {
      let _this = $(this);
      let parentBranch = _this.parent().parent().parent();
      openBranch(_this);
      for (let i = 0; i < parentBranch.siblings().not('.branch-content').length; i++) {
        if (parentBranch.siblings().not('.branch-content').eq(i).find('.branch').length > 0) {
          // console.log(parentBranch.siblings().not('.branch-content').eq(i).find('.icon-fold').eq(0))
          foldBranch(parentBranch.siblings().not('.branch-content').eq(i).find('.icon-fold').eq(0))
        }
      }
      event.stopPropagation();
    });

    //  分支收缩
    let foldBranch = function (_this) {
      let parentBranch = _this.parent().parent().parent();
      parentBranch.find('.branch-content').eq(0).siblings().addClass('d-none');
      _this.addClass('d-none')
      _this.removeClass('d-block')
      parentBranch.find('.icon-open').eq(0).addClass('d-block');
    };

    //  分支展开
    let openBranch = function (_this) {
      let parentBranch = _this.parent().parent().parent();
      parentBranch.find('.branch-content').eq(0).siblings().removeClass('d-none');

      _this.removeClass('d-block')

      parentBranch.find('.icon-fold').eq(0).addClass('d-block');
    };

    // 根据位置添加分支
    let branchLocation = function (parentBranch) {
      parentBranch.append(`
                    <div class="branch position-absolute" style="bottom:0px;left:233px" data-question=""
            data-answer=''>
                            <div class="branch-content">
                                <div class="img-wrapper">
                                  <video src="" alt=""></video>
                                    <span class="icon icon-jia"><i class="iconfont icon-jia1"></i></span>
                                    <img src="images/del.svg" alt="" class="img-fluid position-absolute icon-del"
                  style="top: 5%;right: 5%;">
                                    <img src="images/editor.svg" alt="" class="img-fliud icon-edit d-none" data-toggle="modal"
                  data-target="#modal-edit">
                <img src="images/fold.svg" alt="" class="img-fluid position-absolute d-none icon-fold"
                  style="top: 56%;right: 0;transform: rotate(45deg);z-index: 99;">
                <img src="images/open.svg" alt="" class="img-fluid position-absolute d-none icon-open"
                  style="top: 56%;right: 0;transform: rotate(45deg);z-index: 99;">
                                </div>
                                <p class="text">拖入视频</p>
                                <div class="line position-absolute" style="transform:rotate(0deg)"></div>
                            </div>
                        </div>
                    `)
    }

    //  超过一个位置调整之前分支的位置
    let changeLocation = function (branch, bottom, rotate, lTop) {
      // console.log(branch)
      branch.css('bottom', bottom);
      branch.find('.line').eq(0).css({ 'transform': `rotate(${rotate}deg)`, 'top': lTop })
    }

    //  拖拽功能封装
    let ondragMove = function (dv) {
      //获取元素
      let x = 0;
      let y = 0;
      let l = 0;
      let t = 0;
      let isDown = false;
      //鼠标按下事件
      dv.onmousedown = function (e) {
        //获取x坐标和y坐标
        x = e.clientX;
        y = e.clientY;

        //获取左部和顶部的偏移量
        l = dv.offsetLeft;
        t = dv.offsetTop;
        //开关打开
        isDown = true;
        //设置样式  
        dv.style.cursor = 'move';
      }
      //鼠标移动
      window.onmousemove = function (e) {
        if (isDown == false) {
          return;
        }
        //获取x和y
        let nx = e.clientX;
        let ny = e.clientY;
        //计算移动后的左偏移量和顶部的偏移量
        let nl = nx - (x - l);
        let nt = ny - (y - t);

        dv.style.left = nl + 'px';
        dv.style.top = nt + 'px';
      }
      //鼠标抬起事件
      dv.onmouseup = function () {
        //开关关闭
        isDown = false;
        dv.style.cursor = 'default';
        document.onmousemove = null;
        document.onmouseup = null;
      }
    };
    ondragMove(oContentWrapper);

    //  点击编辑填写问题和答案
    $('#content-wrapper').on('click', '.icon-edit', function (event) {
      let _this = $(this);
      let parentBranch = _this.parent().parent().parent();
      let answer = parentBranch.attr('data-answer');
      answer = answer?JSON.parse(answer):'';

      $('#question').val(parentBranch.attr("data-question"));
      $('#answerA').val(answer.answerA);
      $('#answerB').val(answer.answerB);
      $('#answerC').val(answer.answerC);
      $('#answerD').val(answer.answerD);

      $('#question-save').unbind('click').on('click', function () {
        $('#modal-edit').modal('hide');
        parentBranch.attr("data-question", $('#question').val());
        parentBranch.attr("data-answer", `{"answerA":"${$('#answerA').val()}","answerB":"${$('#answerB').val()}","answerC":"${$('#answerC').val()}","answerD":"${$('#answerD').val()}"}`);

        // console.log(`{"answerA":${$('#answerA').val()},"answerB":${$('#answerB').val()},"answerC":${$('#answerC').val()},"answerD":${$('#answerD').val()}}`,parentBranch)
      })

      // event.stopPropagation();
    });

    //  删除分支
    $('#content-wrapper').on('click', '.icon-del', function (event) {
      let _this = $(this);
      let parentBranch = _this.parent().parent().parent();
      let grandparentBranch = _this.parent().parent().parent().parent();

      parentBranch.remove();
      exchangeBranch(grandparentBranch);
      event.stopPropagation();
    });

    // -----------------------------------------分支逻辑结束--------------------------------------------------------


    // -----------------------------------------视频逻辑开始--------------------------------------------------------
    // 拖动时触发
    document.addEventListener("dragstart", function (event) {
      let $li = $(event.path[1])
      let videoSrc = $li.children().eq(0).attr('src');
      let text = $li.children().eq(1).html();

      event.dataTransfer.setData("Text", `{"videoSrc":"${videoSrc}","title":"${text}"}`);
    });

    // 默认情况下,数据/元素不能在其他元素中被拖放。对于drop我们必须防止元素的默认处理
    document.addEventListener("dragover", function (event) {
      event.preventDefault();
    });

    document.addEventListener("drop", function (event) {
      let data = event.dataTransfer.getData("Text");
      let jsonDate = JSON.parse(data);
      let $branch = $(event.path[2]);
      $branch.find('video').eq(0).attr("src", jsonDate.videoSrc)
      $branch.find('p').eq(0).html(jsonDate.title);
      // console.log($branch);
      event.preventDefault();
    });


    //  发布功能
    $("#publish").on('click', function () {
      // 保存交互视频数据
      var interaction_video_data = {};
      var head_branch = $("#head-branch");

      var all_branch_data = get_video_tree(head_branch);

      window.localStorage.setItem('video',JSON.stringify(all_branch_data));
      window.open("play.html");
    });

    function get_video_tree(parentBranch) {
      // body...
      var data = {};

      // 获取当前分支下的所有子分支
      // console.log(parentBranch);

      var branchs = parentBranch.children(".branch");


      var src = parentBranch.find(".img-wrapper video:first").attr("src");
      var question = parentBranch.attr("data-question");
      let answer = parentBranch.attr('data-answer');
      answer = answer?JSON.parse(answer):'';

      // 递归终止条件
      if (src === "" && branchs.length < 1) {
        return null;
      }

      // 组装数据
      data['src'] = src;
      data['question'] = question;

      // 遍历分支
      var len = branchs.length;
      var i = 0;
      for (var index in answer) {
        if (answer[index] !== "") {
          var sub_data = {
            text: answer[index],
            next_video: get_video_tree(branchs.eq(i++)),
          }
          data[index] = sub_data;
        }
      }

      return data;
    }
    console.log(window.localStorage.getItem('video'));
    
  };
</script>

</html>