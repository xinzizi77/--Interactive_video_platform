<!DOCTYPE html>
<html lang="ch">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>上传视频</title>
  <link rel="stylesheet" href="./font class/iconfont.css">
  <link rel="stylesheet" href="https://neveragain.allstatics.com/2019/assets/style/bootstrap-wondershare.min.css">
  <style>
    * {
      user-select: none;
    }

    ul,
    li {
      padding: 0;
      margin: 0;
    }

    li {
      list-style: none;
    }

    .header {
      width: 100%;
      padding-right: 20px;
      height: 50px;
      line-height: 50px;
      font-size: 16px;
      border-bottom: 1px solid rgb(202, 201, 201);
      text-indent: 20px;
    }

    .main-wrapper {
      width: 100%;

    }

    .main-wrapper .left {
      width: 15%;
      height: 646px;
      padding: 15px;
      box-sizing: border-box;
      float: left;
      border-right: 1px solid rgb(202, 201, 201);
    }

    .main-wrapper .left .top {
      width: 100%;
      color: rgb(124, 124, 124);
    }

    .main-wrapper .left .top .title {
      height: 40px;
      line-height: 40px;
      font-size: 14px;

    }

    .main-wrapper .left .top button {
      width: 120px;
      height: 30px;
      border: none;
      border-radius: 20px;
      background-color: rgb(238, 122, 55);
      color: #fff;
      cursor: pointer;
      outline: none;
      margin: 15px 20px;
    }

    #dataList {
      height: 400px;
      position: relative;
    }

    #dataList .tip {
      position: absolute;
      line-height: 30px;
      width: 91%;
      top: 40%;
      left: 20px;
      text-align: center;
      color: rgb(124, 124, 124);
    }

    .main-wrapper .right {
      width: 85%;
      height: 646px;
      float: left;
      overflow: hidden;
    }

    .main-wrapper .right .title {
      height: 100px;
      padding-right: 20px;
      line-height: 100px;
      font-size: 20px;
      text-align: center;
      letter-spacing: 20px;
      border-bottom: 1px solid rgb(202, 201, 201);
    }

    .main-wrapper .right .content {
      width: 100%;
      height: 100%;
      background-image: linear-gradient(90deg, rgba(180, 180, 180, 0.15) 10%, rgba(0, 0, 0, 0) 10%), linear-gradient(rgba(180, 180, 180, 0.15) 10%, rgba(0, 0, 0, 0) 10%);
      background-size: 20px 20px;
      box-sizing: border-box;
      float: left;
      position: relative;
      overflow: hidden;
    }

    .main-wrapper .right #content-wrapper {
      position: absolute;
    }

    .main-wrapper .right #content-wrapper .branch {
      width: 160px;
      height: 120px;
      border-radius: 10px;
      box-shadow: 4px 4px 20px rgb(184, 184, 184);
      background-color: #fff;
      font-size: 14px;
    }

    #head-branch {
      top: 50px;
      left: 20px;
    }

    .main-wrapper .right #content-wrapper .img-wrapper {
      height: 90px;
      background-color: rgb(158, 157, 157);
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      position: relative;
    }

    .main-wrapper .right #content-wrapper .img-wrapper .head-text {
      width: 65px;
      height: 25px;
      line-height: 25px;
      background-color: rgb(240, 122, 68);
      position: absolute;
      top: 0;
      left: 0;
      color: #fff;
      text-align: center;
    }

    .main-wrapper .right #content-wrapper .img-wrapper .icon {
      position: absolute;
      bottom: -10px;
      right: 10px;
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: rgb(240, 122, 68);
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
      outline: none;
    }

    .main-wrapper .right #content-wrapper p {
      height: 30px;
      line-height: 30px;
      margin: 0;
      text-indent: 10px;
    }

    #videoFile {
      margin-top: 40px;
      text-align: center;
      height: 480px;
      overflow: auto;
      display: none;
    }

    #videoFile li video {
      width: 85%;
      height: 90px;
      border-radius: 5px;
    }

    #videoFile li p {
      font-size: 14px;
    }

    .line {
      top: 50%;
      left: -80px;
      width: 88px;
      height: 1px;
      background-color: rgb(110, 110, 110);
    }
  </style>
</head>

<body>
  <div class="header">互动视频上传</div>
  <div class="main-wrapper">
    <div class="left">
      <div class="top">
        <div class="title">素材库</div>
        <input type="file" id="upfile" name="upfile" style="display: none;" multiple="multiple">
        <button id="imgData"><i class="iconfont icon-shipin"></i> 添加素材</button>
      </div>
      <div id="dataList">
        <div class="tip">你还没有上传视频素材，请上传视频</div>
      </div>
      <ul id="videoFile"></ul>
    </div>
    <div class="right">
      <div class="title">时间轴</div>
      <div class="content p-5">
        <div id="content-wrapper">
          <div class="branch position-relative" id="head-branch">
            <div class="branch-content">
              <div class="img-wrapper">
                <img src="" alt="">
                <span class="head-text">片头</span>
                <span class="icon icon-jia"><i class="iconfont icon-jia1"></i></span>
              </div>
              <p class="text">拖入视频</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://neveragain.allstatics.com/2019/assets/vendor/wsc-vendor.js"></script>
<script src="https://neveragain.allstatics.com/2019/assets/script/wsc-override-ws.js"></script>
<script src="https://neveragain.allstatics.com/2019/assets/script/wsc-common.js"></script>
<script>$(function () { wsc.common.init() })</script>
<script>
  window.onload = function () {
    let oFile = document.getElementById('upfile');
    let oContentWrapper = document.getElementById('content-wrapper');

    //  监听当前点击的是哪个元素
    // $(document).mousedown(function (e) {
    //     console.log($(e.target));  //当前点击的元素
    // })

    $upFile = $("#upfile");
    $("#imgData").click(function () {
      $upFile.click();
      $upFile.off("change").on('change', (function () {
        console.log(oFile.files.length);
        for (let i = 0; i < oFile.files.length; i++) {
          upFile(oFile.files[i]);
        }
      }));
    });

    //  上传视频文件到后台
    let upFile = function (file) {
      let formData = new FormData();
      formData.append("upfile", file);
      $.ajax({
        url: './updata.php',
        type: 'post',
        data: formData,
        dataType: "json",
        cache: false,
        contentType: false,
        processData: false,
        success: function (data) {
          console.log(data);
          $('#dataList').hide();
          $('#videoFile').css('display', 'block');
          addvideoList(data);
        },
        error: function (err) {
          console.log(err);
        }
      });
    };

    //  截取视频的第一帧
    let captureImage = function (video) {
      let scale = 0.8;
      let canvas = document.createElement("canvas");
      canvas.width = 400;
      canvas.height = 200;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      $('#videoFile').html(`<img src="${canvas.toDataURL("image/png")}" alt="">
                    <span>${video.name}</span>`);
    };

    //  上传视频成功后加入素材库
    let addvideoList = function (video) {
      $('#videoFile').append(`<li><video src="./upload/${video.src}" draggable="true"></video>
                    <p>${video.name.split('.')[0]}</p></li>`);
    }

    // document.ondragenter = function (e) {
    //     e.preventDefault(); //使得ondrop可能触发
    // }

    // document.ondragover = function (e) {
    //     e.preventDefault();//阻止浏览器在新窗口中打开本地图片
    // }

    // 视频拖入画布功能
    let dragVideo = function () {
      $('#videoFile').find('video').forEach(video => {
      });
    }

    let addBranch = function () {
      $('#content-wrapper').on('click', '.icon-jia', function (event) {
        let _this = $(this);
        let parentBranch = _this.parent().parent().parent();
        console.log(parentBranch.find('.branch').find('.line'))

        switch (parentBranch.find('.branch').length) {
          case 0: branchLocation(parentBranch); break;
          case 1: changeLocation(parentBranch.find('.branch').eq(0), "80px", '-40','90%');
          branchLocation(parentBranch);
          changeLocation(parentBranch.find('.branch').eq(1), "-80px", '40','10%'); break;
          case 2: changeLocation(parentBranch.find('.branch').eq(0), "80px", '-40','90%');
          branchLocation(parentBranch);branchLocation(parentBranch);
          changeLocation(parentBranch.find('.branch').eq(2), "-80px", '40','10%'); break;
        }

        // branchLocation(parentBranch)
        // let bottm = 0;
        // let left = parseInt(parentBranch.css('left')) + 253;
        event.stopPropagation();
      });
    };

    // 根据位置添加分支
    let branchLocation = function (parentBranch) {
      parentBranch.append(`
                    <div class="branch position-absolute" style="bottom:0px;left:233px">
                            <div class="branch-content">
                                <div class="img-wrapper">
                                    <img src="" alt="">
                                    <span class="icon icon-jia"><i class="iconfont icon-jia1"></i></span>
                                </div>
                                <p class="text">拖入视频</p>
                                <div class="line position-absolute" style="transform:rotate(0deg)"></div>
                            </div>
                        </div>
                    `)
    }

    // 超过一个位置调整之前分支的位置
    let changeLocation = function (branch, bottom, rotate, lTop) {
      console.log(branch)
      branch.css('bottom',bottom);
      branch.find('.line').css({'transform':`rotate(${rotate}deg)`,'top':lTop})
    }

    addBranch();

    //  拖拽功能封装
    let ondragMove = function (dv) {
      //获取元素
      let x = 0;
      let y = 0;
      let l = 0;
      let t = 0;
      let isDown = false;
      //鼠标按下事件
      dv.onmousedown = function (e) {
        //获取x坐标和y坐标
        x = e.clientX;
        y = e.clientY;

        //获取左部和顶部的偏移量
        l = dv.offsetLeft;
        t = dv.offsetTop;
        //开关打开
        isDown = true;
        //设置样式  
        dv.style.cursor = 'move';
      }
      //鼠标移动
      window.onmousemove = function (e) {
        if (isDown == false) {
          return;
        }
        //获取x和y
        let nx = e.clientX;
        let ny = e.clientY;
        //计算移动后的左偏移量和顶部的偏移量
        let nl = nx - (x - l);
        let nt = ny - (y - t);

        dv.style.left = nl + 'px';
        dv.style.top = nt + 'px';
      }
      //鼠标抬起事件
      dv.onmouseup = function () {
        //开关关闭
        isDown = false;
        dv.style.cursor = 'default';
        document.onmousemove = null;
        document.onmouseup = null;
      }
    };
    ondragMove(oContentWrapper);
  };


</script>

</html>